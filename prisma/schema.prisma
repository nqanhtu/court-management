generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// 1. Phân quyền & Người dùng Hệ thống
// ==========================================

enum UserRole {
  SUPER_ADMIN // SuperAdmin: Toàn quyền, quản lý user
  ADMIN // Admin (Chánh án): Xem, sửa, xoá hồ sơ, xem phiếu mượn
  VIEWER // View (Thẩm phán): Xem hồ sơ
  COORDINATOR // Coordinate: Xem hồ sơ, tạo phiếu mượn trả, xem vị trí lưu kho
}

model User {
  id       String   @id @default(uuid())
  username String   @unique
  password String // Hashed
  fullName String
  role     UserRole @default(VIEWER)

  // Thông tin thêm
  unit   String? // Đơn vị
  status Boolean @default(true) // Active/Inactive

  // Quan hệ
  auditLogs   AuditLog[]
  borrowSlips BorrowSlip[] @relation("Lender")

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  borrowSlipEvents BorrowSlipEvent[]
}

// ==========================================
// 2. File Management & Storage
// ==========================================

// Agency Name History (Storage Font)
model AgencyHistory {
  id        String    @id @default(uuid())
  name      String // Agency Name (e.g., TAND Binh Duong)
  startDate DateTime // Start period
  endDate   DateTime? // End period (null = present)

  boxes StorageBox[]
}

// Location & Box Management
model StorageBox {
  id   String @id @default(uuid())
  code String @unique // Box code (generated or QR code content)

  // Physical Location (Warehouse -> Line -> Shelf -> Slot -> Box)
  warehouse String // Warehouse
  line      String // Line
  shelf     String // Shelf
  slot      String // Slot/Compartment
  boxNumber String // Box Number (sequential)

  // Box Label Info
  agencyId     String?
  agency       AgencyHistory? @relation(fields: [agencyId], references: [id])
  caseType     String? // Case Type (Criminal, Civil...)
  year         Int? // Year
  fromFileCode String? // From File Code
  toFileCode   String? // To File Code
  retention    String? // Retention Period (Permanent, 10 years...)

  files File[]

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  storageBoxLabels StorageBoxLabel[]

  @@index([warehouse, line, shelf, slot])
}

model StorageBoxLabel {
  id           String      @id @default(uuid())
  agencyId     String?
  fromYear     Int?
  toYear       Int?
  label        String
  storageBoxId String?
  storageBox   StorageBox? @relation(fields: [storageBoxId], references: [id])
}

// Case File (File Jacket)
model File {
  id   String @id @default(uuid())
  code String @unique // Convention: Code - Type - Year - #

  // General Info (Sheet 1)
  title     String // Title
  type      String // Case Type (Criminal, Civil...)
  datetime  DateTime // File Date
  year      Int? // Year (Filter)
  pageCount Int? // Page Count

  // Details (JSON for flexibility: Defendant, Plaintiff, Summary...)
  details Json?

  // Time & Retention
  judgmentDate DateTime? // Judgment Date
  retention    String? // Retention Period (Permanent, 10 years...)

  // New fields from Excel analysis
  note      String? // Note
  indexCode String? // File Index Code (MLHS)

  judgmentNumber  String? // Judgment Number
  defendants      String[] // Defendants
  plaintiffs      String[] // Plaintiffs
  civilDefendants String[] // Civil Defendants

  // Status & Lock
  isLocked Boolean @default(false) // Locked (Admin only edit)
  status   String  @default("IN_STOCK") // IN_STOCK, BORROWED, LOST

  // Relations
  boxId       String?
  box         StorageBox?  @relation(fields: [boxId], references: [id])
  fileIndex   FileIndex?
  documents   Document[] // Child Documents (Sheet 2)
  borrowItems BorrowItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FileIndex {
  id     String @id @default(uuid())
  fileId String @unique
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  attachments  String[]
  totalPage    Int
  judgmentTime DateTime
}

// Documents within File (Sheet 2 - Document List)
model Document {
  id        String  @id @default(uuid())
  code      String? // Child Document Code (if any - corresponds to File No in Excel)
  title     String // Title / Abstract
  year      Int?
  pageCount Int? // Page Count
  order     Int? // Order Number

  // New fields form Excel
  contentIndex     String? // Document Index
  preservationTime String? // Preservation Period
  note             String? // Note

  fileId String
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)
}

// ==========================================
// 3. Mượn Trả
// ==========================================

model BorrowSlip {
  id   String @id @default(uuid())
  code String @unique // Mã phiếu (PM-YYYY-XXX)

  // Thông tin người mượn (Khách) - Lưu text vì không phải User hệ thống
  borrowerName  String
  borrowerUnit  String? // Đơn vị/Phòng ban
  borrowerTitle String? // Chức danh
  reason        String? // Lý do mượn

  // Thông tin phiếu
  borrowDate   DateTime  @default(now())
  dueDate      DateTime // Hạn trả
  returnedDate DateTime? // Ngày trả hết toàn bộ
  status       String    @default("BORROWING") // BORROWING, PARTIAL_RETURN, RETURNED, OVERDUE

  // Người lập phiếu (Cán bộ lưu trữ)
  lenderId String
  lender   User   @relation("Lender", fields: [lenderId], references: [id])

  items  BorrowItem[]
  events BorrowSlipEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BorrowItem {
  id String @id @default(uuid())

  borrowSlipId String
  borrowSlip   BorrowSlip @relation(fields: [borrowSlipId], references: [id], onDelete: Cascade)

  fileId String
  file   File   @relation(fields: [fileId], references: [id])

  returnedDate DateTime? // Ngày trả cụ thể
  status       String    @default("BORROWING") // BORROWING, RETURNED
  condition    String? // Tình trạng khi trả

  @@unique([borrowSlipId, fileId])
}

model BorrowSlipEvent {
  id           String     @id @default(uuid())
  borrowSlipId String
  borrowSlip   BorrowSlip @relation(fields: [borrowSlipId], references: [id], onDelete: Cascade)

  eventType   String // CREATED, RETURNED_PARTIAL, RETURNED_ALL, EXTENDED, ADD_FILE, REMOVE_FILE, NOTE
  description String? // "Trả 2 hồ sơ", "Mượn thêm hồ sơ ABC"
  details     Json? // { fileIds: ["..."], changes: {} }

  creatorId String?
  creator   User?   @relation(fields: [creatorId], references: [id])

  createdAt DateTime @default(now())
}

// ==========================================
// 4. Audit & System
// ==========================================

model AuditLog {
  id        String      @id @default(uuid())
  action    AuditAction // LOGIN, VIEW, CREATE, UPDATE, DELETE, EXPORT
  target    String // Tên bảng/đối tượng bị tác động (File/User...)
  targetId  String? // ID đối tượng
  detail    Json? // Chi tiết thay đổi (Old value -> New value)
  ipAddress String?

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

enum AuditAction {
  LOGIN
  VIEW
  CREATE
  UPDATE
  DELETE
  EXPORT
  UPLOAD
}
